{{ partial "header" . }}
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css" rel="stylesheet" />
  <style>
        #map {
        height: 100%;
        }
        img {
          width: 150pt;
          height: auto;
        }
        @media (prefers-color-scheme: dark) {
          div.page-content {
            background-color: #222;
            color: #ccc;
          }
          .mapboxgl-popup-anchor-left .mapboxgl-popup-tip { border-right-color: #222;}
          .mapboxgl-popup-anchor-right .mapboxgl-popup-tip { border-left-color: #222;}
          .mapboxgl-popup-anchor-top .mapboxgl-popup-tip { border-bottom-color: #222;}
          .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip { border-top-color: #222;}
          .mapboxgl-popup-content {
            background: #222;
            color: #ccc;
          }
          .year-filter {
            border-top-color: #444;
          }
          .timeline-slider {
            --track-color: #444;
          }
        }

        footer { display: none;}

        .timeline-slider {
          position: relative;
          width: 200px;
          height: 30px;
          --track-color: #ccc;
        }

        .timeline-slider input[type="range"] {
          position: absolute;
          width: 100%;
          height: 4px;
          top: -4px;
          z-index: 99;
          background: transparent;
          pointer-events: none;
          -webkit-appearance: none;
        }

        .timeline-slider input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background: #009988;
          cursor: pointer;
          pointer-events: auto;
          margin-top: -6px;
        }

        .timeline-slider input[type="range"]::-moz-range-thumb {
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background: #009988;
          cursor: pointer;
          pointer-events: auto;
          border: none;
        }

        .timeline-track {
          position: absolute;
          top: -3px;
          width: 100%;
          height: 2px;
          background: var(--track-color);
          border-radius: 2px;
        }

        .timeline-labels {
          display: flex;
          justify-content: space-between;
          font-size: 12px;
          line-height: 30px;
          margin-top: 8px;
          color: inherit;
        }
  </style>
    <div class="site">
      <div class="site-content" id="map">
        <span class="mapbox-maplogo"></span>
      </div>

      <!-- site-content -->
        <div class="map-page-content">
        {{ .Content }}
          <!-- Map layer controls -->
          <div class="map-controls">
            Show: 
            <label>
              <input type="checkbox" id="toggle-flights" checked>
              Flights
            </label>
            <label>
              <input type="checkbox" id="toggle-places" checked>
              Places
            </label>
            <div class="year-filter">
              <label for="year-range">Year range:</label>
              <div class="timeline-slider">
                <input type="range" id="year-start" min="1990" max="2030" value="1990">
                <input type="range" id="year-end" min="1990" max="2030" value="2030">
                <div class="timeline-track"></div>
                <div class="timeline-labels">
                  <span id="year-start-label">1990</span>
                  <span>-</span>
                  <span id="year-end-label">2030</span>
                </div>
              </div>
              <button id="clear-filters">Reset</button>
            </div>
          </div>        
        </div>
<script type="text/javascript">

document.getElementById('map').style.height=(window.innerHeight-57) + "px";
mapboxgl.accessToken = 'pk.eyJ1Ijoicmlja3ltb29yaG91c2UiLCJhIjoiY2lnemh4eGF1MHc0NDRwbTNteW9sN2p0NyJ9.P_XKTG1fyN2jP_R_G1JMdQ';

var theme = document.documentElement.getAttribute('data-theme') || localStorage.getItem('theme');
var style = theme === 'dark' ? 'mapbox://styles/mapbox/dark-v10' : 'mapbox://styles/mapbox/light-v10';

// Function to update map style based on theme
function updateMapTheme(theme) {
  var newStyle = theme === 'dark' ? 'mapbox://styles/mapbox/dark-v10' : 'mapbox://styles/mapbox/light-v10';
  if (map.getStyle() !== newStyle) {
    map.setStyle(newStyle);
    // Re-add layers after style reload
    setTimeout(function() {
      map.addSource('points', {
        type: 'geojson',
        data: '{{ .Params.geojson }}',
        cluster: false,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });
      map.addLayer({
        id: 'points',
        type: 'circle',
        source: 'points',
        paint: {
          'circle-color': ['get', 'marker-color'],
          'circle-radius': 5,
        }
      });
      map.addSource('flights', {
        type: 'geojson',
        data: '/flights.json'
      });
      map.addLayer({
        id: 'flight-routes',
        type: 'line',
        source: 'flights',
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        },
        paint: {
          'line-color': '#009988',
          'line-width': 1.5,
          'line-opacity': 0.7,
          'line-dasharray': [2, 2]
        }
      });
      document.getElementById('toggle-flights').checked = true;
      document.getElementById('toggle-places').checked = true;
    }, 1000);
  }
}

// Listen for theme changes
var themeObserver = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.attributeName === 'data-theme') {
      var theme = document.documentElement.getAttribute('data-theme');
      if (theme) {
        updateMapTheme(theme);
      }
    }
  });
});
themeObserver.observe(document.documentElement, { attributes: true });

var map = new mapboxgl.Map({
  container: 'map', // container id
  style: style, // stylesheet location
  center: [-20, 20], // starting position [lng, lat]
  projection: 'equalEarth',
  zoom: 2 // starting zoom
});

var allFlightData = null;
var allPlacesData = null;
var allYears = new Set();

map.on('load', function() {
  map.addSource('points', {
    type: 'geojson',
    data: '{{ .Params.geojson }}',
    cluster: false,
    clusterMaxZoom: 14, // Max zoom to cluster points on
    clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
    })
  map.addLayer({
    id: 'points',
    type: 'circle',
    source: 'points',
    paint: {
      'circle-color': '#CC6633', //['get', 'marker-color'],
      'circle-radius': 4,
    }
  });

  // Flights layer - line routes
  map.addSource('flights', {
    type: 'geojson',
    data: '/flights.json'
  });

  map.addLayer({
    id: 'flight-routes',
    type: 'line',
    source: 'flights',
    layout: {
      'line-join': 'round',
      'line-cap': 'round'
    },
    paint: {
      'line-color': '#009988',
      'line-width': 1.5,
      'line-opacity': 0.7,
      'line-dasharray': [2, 2]
    }
  });

  // Load all flight data and populate year filter
  Promise.all([
      fetch('/flights.json').then(r => r.json()),
      fetch('{{ .Params.geojson }}').then(r => r.json())
    ])
    .then(([flightData, placesData]) => {
      allFlightData = flightData;
      allPlacesData = placesData;
      initTimelineSlider(flightData, placesData);
    })
    .catch(error => console.error('Error loading map data:', error));

  var popup = new mapboxgl.Popup({closeButton: true, closeOnClick: true});

  map.on('mouseenter', 'points', function(e) {
    map.getCanvas().style.cursor = 'pointer';
  });
  map.on('click', 'points', function(e) {
    var coordinates = e.features[0].geometry.coordinates.slice();
    var content = ''
    if (e.features[0].properties.url) {
      content = content + '<a href="'+e.features[0].properties.url+'">';
      if (e.features[0].properties.image) {
        content = content + '<img src="' + e.features[0].properties.image + '"/><br />';
        params = {minWidth: 200, autoPanPaddingTopLeft: 200}
      } else {
        params = {}
      }
      content = content + e.features[0].properties.title + '</a>';
    } else {
      content = content + e.features[0].properties.title;
    }

  
    // Ensure that if the map is zoomed out such that
    // multiple copies of the feature are visible, the
    // popup appears over the copy being pointed to.
    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }

    popup.setLngLat(coordinates)
      .setHTML(content)
      .addTo(map);
  });
  map.on('mouseleave', 'places', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
  });
});

// Initialize timeline slider
function initTimelineSlider(flightData, placesData) {
  const years = new Set();
  
  flightData.features.forEach(feature => {
    const year = parseInt(feature.properties.year);
    if (feature.properties.year && !isNaN(year) && year >= 1900 && year <= 2100) {
        years.add(year);
    }
  });

  placesData.features.forEach(feature => {
    if (feature.properties && feature.properties.years) {
      feature.properties.years.forEach(y => {
        const year = parseInt(y);
        if (y && !isNaN(year) && year >= 1900 && year <= 2100) {
          years.add(year);
        }
      });
    }
  });

  // Filter out any NaN values that might have crept in
  years.delete(NaN);
  
  if (years.size === 0) {
    console.warn('No valid years found in data');
    return;
  }

  const minYear = Math.min(...years);
  const maxYear = Math.max(...years);

  const startInput = document.getElementById('year-start');
  const endInput = document.getElementById('year-end');
  
  startInput.min = minYear;
  startInput.max = maxYear;
  endInput.min = minYear;
  endInput.max = maxYear;
  
  startInput.value = minYear;
  endInput.value = maxYear;
  
  document.getElementById('year-start-label').textContent = minYear;
  document.getElementById('year-end-label').textContent = maxYear;

  // Handle range input interaction
  function updateRange() {
    let start = parseInt(startInput.value);
    let end = parseInt(endInput.value);
    
    if (start > end) {
      startInput.value = end;
      start = end;
    }
    
    document.getElementById('year-start-label').textContent = start;
    document.getElementById('year-end-label').textContent = end;
    
    filterByYearRange(start, end);
  }

  startInput.addEventListener('input', updateRange);
  endInput.addEventListener('input', updateRange);
  
  // Trigger initial filter with the slider values (which are now set to minYear/maxYear)
  const initialStart = parseInt(startInput.value);
  const initialEnd = parseInt(endInput.value);
  filterByYearRange(initialStart, initialEnd);
}

// Filter both flights and places by year range
function filterByYearRange(startYear, endYear) {
  if (!allFlightData || !allPlacesData) return;

  // Filter flights (only show if flight year is in range)
  const filteredFlights = {
    type: 'FeatureCollection',
    features: allFlightData.features.filter(f => {
      const year = parseInt(f.properties.year);
      return !isNaN(year) && year >= startYear && year <= endYear;
    })
  };
  map.getSource('flights').setData(filteredFlights);

  // Filter places (show if any visit year is in range, or if no year data)
  const filteredPlaces = {
    type: 'FeatureCollection',
    features: allPlacesData.features.filter(f => {
      if (f.properties) {
        const years = f.properties.years || [];
        // Show if: empty years array (unknown date), OR at least one year in range
        if (years.length === 0) return true;
        return years.some(y => {
          const year = parseInt(y);
          return !isNaN(year) && year >= startYear && year <= endYear;
        });
      }
    })
  };
  console.log(filteredPlaces);
  map.getSource('points').setData(filteredPlaces);
}

// Clear filters
document.getElementById('clear-filters').addEventListener('click', function() {
  const startInput = document.getElementById('year-start');
  const endInput = document.getElementById('year-end');
  startInput.value = startInput.min;
  endInput.value = endInput.max;
  document.getElementById('year-start-label').textContent = startInput.min;
  document.getElementById('year-end-label').textContent = endInput.max;
  filterByYearRange(parseInt(startInput.min), parseInt(endInput.max));
});

// Toggle flight routes
document.getElementById('toggle-flights').addEventListener('change', function(e) {
  map.setLayoutProperty('flight-routes', 'visibility', e.target.checked ? 'visible' : 'none');
});
// Toggle flight routes
document.getElementById('toggle-places').addEventListener('change', function(e) {
  map.setLayoutProperty('points', 'visibility', e.target.checked ? 'visible' : 'none');
});


function insertMap(geojson_url) {
  var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/mapbox/light-v9', //'mapbox://styles/rickymoorhouse/cih6ouins00f3bnm500a1d3dl',
      center: [-53, 20], // starting position
      zoom: 1.5 // starting zoom
  });
  map.on('load', function() {
    map.addSource("visited", {
      type: 'geojson',
      data: geojson_url
    });
    map.addLayer({
       "id": "points",
       "type": "symbol",
       "source": "visited",
       "layout": {
           "icon-image": "star-11",
           //"text-field": "{name}",
           "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
           "text-offset": [0, 0.6],
           "text-anchor": "top"
       }
     });
  });
}

</script>
    </div>
  </body>
</html>
