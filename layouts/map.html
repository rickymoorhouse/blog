{{ partial "header" . }}
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />
  <style>
        #map {
        height: 100%;
        }
        img {
          width: 150pt;
          height: auto;
        }
        div.page-content {
        position:fixed;
        bottom: 100px;
        margin-top: 1em;
        right: 1em;
        z-index: 999;
        background: white;
        width: 20em;
        padding: 0.5em;
        box-shadow: 1pt 1pt 3pt rgba(0,0,0,0.5);
        }
        .map-controls {
        position: fixed;
        top: 80px;
        left: 80px;
        z-index: 999;
        background: white;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 1px 3pt rgba(0,0,0,0.5);
        }
        .map-controls label {
        display: block;
        margin: 5px 0;
        cursor: pointer;
        }
        @media (prefers-color-scheme: dark) {
          div.page-content, .map-controls {
            background-color: #222;
            color: #ccc;
          }
          .mapboxgl-popup-anchor-left .mapboxgl-popup-tip { border-right-color: #222;}
          .mapboxgl-popup-anchor-right .mapboxgl-popup-tip { border-left-color: #222;}
          .mapboxgl-popup-anchor-top .mapboxgl-popup-tip { border-bottom-color: #222;}
          .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip { border-top-color: #222;}
          .mapboxgl-popup-content {
            background: #222;
            color: #ccc;
          }          
        }

        footer { display: none;}
  </style>
    <div class="site">
      <div class="site-content" id="map">
        <span class="mapbox-maplogo"></span>
      </div>
      
      <!-- Map layer controls -->
      <div class="map-controls">
        <label>
          <input type="checkbox" id="toggle-flights" checked>
          Show Flights
        </label>
        <label>
          <input type="checkbox" id="toggle-places" checked>
          Show Places
        </label>
      </div>
      
      <!-- site-content -->
        <div class="page-content">
        {{ .Content }}
        </div>
<script type="text/javascript">

document.getElementById('map').style.height=(window.innerHeight-57) + "px";
mapboxgl.accessToken = 'pk.eyJ1Ijoicmlja3ltb29yaG91c2UiLCJhIjoiY2lnemh4eGF1MHc0NDRwbTNteW9sN2p0NyJ9.P_XKTG1fyN2jP_R_G1JMdQ';

var style = 'mapbox://styles/mapbox/light-v10';
if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
  style = 'mapbox://styles/mapbox/dark-v10'
}

var map = new mapboxgl.Map({
  container: 'map', // container id
  style: style, // stylesheet location
  center: [-20, 20], // starting position [lng, lat]
  projection: 'equalEarth',
  zoom: 2 // starting zoom
});

map.on('load', function() {
  // Places layer
  map.addSource('points', {
    type: 'geojson', 
    data: '{{ .Params.geojson }}',
    cluster: false,
    clusterMaxZoom: 14,
    clusterRadius: 50
  });
  map.addLayer({
    id: 'points',
    type: 'circle',
    source: 'points',
    paint: {
      'circle-color': ['get', 'marker-color'],
      'circle-radius': 5,
    }
  });

  // Flights layer - line routes
  map.addSource('flights', {
    type: 'geojson',
    data: '/map/flights.json'
  });
  
  map.addLayer({
    id: 'flight-routes',
    type: 'line',
    source: 'flights',
    layout: {
      'line-join': 'round',
      'line-cap': 'round'
    },
    paint: {
      'line-color': '#009988',
      'line-width': 1.5,
      'line-opacity': 0.7,
      'line-dasharray': [2, 2]
    }
  });

  var popup = new mapboxgl.Popup({closeButton: true, closeOnClick: true});

  map.on('mouseenter', 'points', function(e) {
    map.getCanvas().style.cursor = 'pointer';
  });
  map.on('click', 'points', function(e) {
    var coordinates = e.features[0].geometry.coordinates.slice();
    var content = ''
    if (e.features[0].properties.url) {
      content = content + '<a href="'+e.features[0].properties.url+'">';
      if (e.features[0].properties.image) {
        content = content + '<img src="' + e.features[0].properties.image + '"/><br />';
        params = {minWidth: 200, autoPanPaddingTopLeft: 200}
      } else {
        params = {}
      }
      content = content + e.features[0].properties.title + '</a>';
    } else {
      content = content + e.features[0].properties.title;
    }

    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
    }
  
    popup.setLngLat(coordinates)
      .setHTML(content)
      .addTo(map);
  });
  map.on('mouseleave', 'places', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
  });
});

// Toggle flight routes
document.getElementById('toggle-flights').addEventListener('change', function(e) {
  map.setLayoutProperty('flight-routes', 'visibility', e.target.checked ? 'visible' : 'none');
});

// Toggle places
document.getElementById('toggle-places').addEventListener('change', function(e) {
  map.setLayoutProperty('points', 'visibility', e.target.checked ? 'visible' : 'none');
});

</script>
    </div>
  </body>
</html>
