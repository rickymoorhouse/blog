name: Hugo
on: [push]
jobs:

  build:
    name: Build-site
    runs-on: ubuntu-latest
    steps:

    - name: Check out code
      uses: actions/checkout@v1

    - name: Get hugo
      run: |
        curl -LO https://github.com/gohugoio/hugo/releases/download/v0.73.0/hugo_0.73.0_Linux-64bit.tar.gz
        tar -vzxf hugo_0.73.0_Linux-64bit.tar.gz
        chmod a+x hugo

    - name: Set build ref
      if: github.ref != 'refs/heads/master'
      run: |
        sed -i 's/build = "main"/build = "preview"/' config.toml
        sed -i 's/rickymoorhouse.uk/drafts.rickymoorhouse.uk/' config.toml

    - name: Build
      run: ./hugo
    - name: Archive production artifacts
      uses: actions/upload-artifact@v2
      with:
        name: blog-content
        path: |
          public

  deploy:
    name: Upload-site
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Download site content
      uses: actions/download-artifact@v2
      with: 
        name: blog-content
    - name: SSH setup
      env:
        DEPLOY_KEY: ${{ secrets.ssh_private_key }}
        KNOWN_HOSTS: ${{ secrets.known_hosts }}
      run: |
        mkdir -p ~/.ssh
        echo "${DEPLOY_KEY}" > ~/.ssh/rsync_key
        echo "${KNOWN_HOSTS}" >> ~/.ssh/known_hosts
        chmod -R 700 ~/.ssh

    - name: Deploy to drafts
      if: github.ref != 'refs/heads/master'
      run: |
        rsync -e 'ssh -p 22022 -i ~/.ssh/rsync_key' -arz --no-t * github@drafts.rickymoorhouse.uk:/var/www/rickymoorhouse.uk/

    - name: Deploy to live site
      if: github.ref == 'refs/heads/master'
      run: |
        rsync -e 'ssh -p 22022 -i ~/.ssh/rsync_key' -arz --no-t * github@rickymoorhouse.uk:/var/www/rickymoorhouse.uk/
